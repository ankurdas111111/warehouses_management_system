<div class="card">
  <h2>Place an order</h2>
  <p class="muted">This is a minimal UI over the same concurrency-safe reservation system.</p>

  <% if @error.present? %>
    <div class="error"><%= @error %></div>
  <% end %>

  <form method="post" action="<%= orders_path %>">
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <%= hidden_field_tag :idempotency_key, (@prefill && @prefill[:idempotency_key]).presence || @idempotency_key %>

    <p class="muted">Ordering as <strong><%= current_user.email %></strong></p>

    <h3>Items</h3>
    <table id="lines">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Qty</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% lines = (@prefill && @prefill[:lines]).presence || [{ sku_code: (@skus.first&.code || ""), quantity: 1 }] %>
        <% lines.each_with_index do |line, idx| %>
          <tr>
            <td>
              <select name="lines[][sku_code]" required>
                <% @skus.each do |s| %>
                  <option value="<%= s.code %>" <%= "selected" if s.code == line[:sku_code].to_s %>><%= s.code %> â€” <%= s.name %></option>
                <% end %>
              </select>
            </td>
            <td>
              <input type="number" name="lines[][quantity]" min="1" required value="<%= line[:quantity].to_i %>">
            </td>
            <td>
              <button type="button" class="secondary" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="row">
      <button type="button" class="secondary" onclick="addRow()">Add item</button>
      <button type="submit">Create Order</button>
    </div>

    <p class="muted">
      Tip: we generate an idempotency key automatically for this form to avoid duplicate orders on refresh/retry.
    </p>
  </form>
</div>

<script>
  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (!tr) return;
    const tbody = document.querySelector("#lines tbody");
    if (tbody && tbody.querySelectorAll("tr").length <= 1) return;
    tr.remove();
  }

  function addRow() {
    const tbody = document.querySelector("#lines tbody");
    if (!tbody) return;
    const first = tbody.querySelector("tr");
    if (!first) return;
    const clone = first.cloneNode(true);
    // reset qty
    const qty = clone.querySelector('input[type="number"]');
    if (qty) qty.value = 1;
    tbody.appendChild(clone);
  }
</script>


