<div class="card">
  <div class="page-header">
    <div>
      <h2>SKUs</h2>
      <p class="muted">Total: <strong><%= @total.to_i %></strong></p>
    </div>
    <div class="page-actions">
      <a class="btn secondary" href="<%= admin_inventory_index_path %>">Inventory</a>
      <a class="btn secondary" href="<%= admin_root_path %>">Admin home</a>
    </div>
  </div>

  <form method="get" action="<%= admin_skus_path %>" class="row mt-10">
    <label>
      Search<br>
      <input name="q" value="<%= @q.to_s %>" placeholder="code/name">
    </label>
    <input type="hidden" name="per" value="<%= @per.to_i %>">
    <button type="submit" class="secondary">Search</button>
    <a class="muted" href="<%= admin_skus_path %>">Clear</a>
  </form>

  <% if @skus.empty? %>
    <div class="empty mt-10">
      <p class="muted m-0">No SKUs found.</p>
    </div>
  <% else %>
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Price (INR)</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @skus.each do |s| %>
          <tr data-sku-row="<%= s.id %>">
            <td>
              <span data-view><%= s.code %></span>
              <input data-edit name="sku[code]" value="<%= s.code %>" class="hidden w-180" required>
            </td>
            <td>
              <span data-view><%= s.name %></span>
              <input data-edit name="sku[name]" value="<%= s.name %>" class="hidden w-380" required>
            </td>
            <td>
              <span data-view><%= s.respond_to?(:price_inr_display) ? s.price_inr_display : (s.price_cents.to_i / 100.0) %></span>
              <input data-edit name="sku[price_inr]" value="<%= s.respond_to?(:price_inr) ? format('%.2f', s.price_inr) : format('%.2f', (s.price_cents.to_i / 100.0)) %>" class="hidden w-140" required>
            </td>
            <td class="row justify-end">
              <button type="button" class="secondary" data-edit-btn>Edit</button>

              <form data-update-form method="post" action="<%= admin_sku_path(s) %>" class="hidden">
                <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                <input type="hidden" name="_method" value="patch">
                <input type="hidden" name="sku[code]" value="<%= s.code %>" data-hidden-code>
                <input type="hidden" name="sku[name]" value="<%= s.name %>" data-hidden-name>
                <input type="hidden" name="sku[price_inr]" value="<%= s.respond_to?(:price_inr) ? format('%.2f', s.price_inr) : format('%.2f', (s.price_cents.to_i / 100.0)) %>" data-hidden-price>
                <button type="submit">Save</button>
                <button type="button" class="secondary" data-cancel-btn>Cancel</button>
              </form>

              <form method="post" action="<%= admin_sku_path(s) %>" onsubmit="return confirm('Delete this SKU?');">
                <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                <input type="hidden" name="_method" value="delete">
                <button type="submit" class="secondary">Delete</button>
              </form>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <div class="row justify-between mt-10">
    <% if @page.to_i > 1 %>
      <a class="muted" href="<%= admin_skus_path(q: @q, page: (@page.to_i - 1), per: @per) %>">← Prev</a>
    <% else %>
      <span></span>
    <% end %>

    <% if (@page.to_i * @per.to_i) < @total.to_i %>
      <a class="muted" href="<%= admin_skus_path(q: @q, page: (@page.to_i + 1), per: @per) %>">Next →</a>
    <% end %>
  </div>
</div>

<script>
  (function () {
    function toggleRow(row, editing) {
      const viewEls = row.querySelectorAll("[data-view]");
      const editEls = row.querySelectorAll("input[data-edit]");
      const editBtn = row.querySelector("[data-edit-btn]");
      const updateForm = row.querySelector("form[data-update-form]");
      if (!editBtn || !updateForm) return;

      viewEls.forEach((el) => el.classList.toggle("hidden", editing));
      editEls.forEach((el) => el.classList.toggle("hidden", !editing));
      editBtn.classList.toggle("hidden", editing);

      if (editing) {
        updateForm.classList.remove("hidden");
        updateForm.style.display = "inline-flex";
      } else {
        updateForm.classList.add("hidden");
        updateForm.style.display = "";
      }
    }

    document.querySelectorAll("tr[data-sku-row]").forEach((row) => {
      const editBtn = row.querySelector("[data-edit-btn]");
      const cancelBtn = row.querySelector("[data-cancel-btn]");
      const codeInput = row.querySelector('input[data-edit][name="sku[code]"]');
      const nameInput = row.querySelector('input[data-edit][name="sku[name]"]');
      const priceInput = row.querySelector('input[data-edit][name="sku[price_inr]"]');
      const hiddenCode = row.querySelector("[data-hidden-code]");
      const hiddenName = row.querySelector("[data-hidden-name]");
      const hiddenPrice = row.querySelector("[data-hidden-price]");

      if (editBtn) {
        editBtn.addEventListener("click", function () {
          toggleRow(row, true);
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener("click", function () {
          // reset inputs to original values from hidden fields
          if (codeInput && hiddenCode) codeInput.value = hiddenCode.value;
          if (nameInput && hiddenName) nameInput.value = hiddenName.value;
          if (priceInput && hiddenPrice) priceInput.value = hiddenPrice.value;
          toggleRow(row, false);
        });
      }

      function syncHidden() {
        if (codeInput && hiddenCode) hiddenCode.value = codeInput.value;
        if (nameInput && hiddenName) hiddenName.value = nameInput.value;
        if (priceInput && hiddenPrice) hiddenPrice.value = priceInput.value;
      }

      if (codeInput) codeInput.addEventListener("input", syncHidden);
      if (nameInput) nameInput.addEventListener("input", syncHidden);
      if (priceInput) priceInput.addEventListener("input", syncHidden);
    });
  })();
</script>


