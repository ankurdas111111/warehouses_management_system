<div class="card">
  <div class="page-header">
    <div>
      <h2>Place an order</h2>
      <p class="muted">Concurrency-safe reservations with live totals.</p>
    </div>
    <div class="page-actions">
      <a class="btn secondary" href="<%= orders_path %>">My orders</a>
    </div>
  </div>

  <% if @error.present? %>
    <div class="error"><%= @error %></div>
  <% end %>

  <form method="post" action="<%= orders_path %>">
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <%= hidden_field_tag :idempotency_key, (@prefill && @prefill[:idempotency_key]).presence || @idempotency_key %>

    <p class="muted">Ordering as <strong><%= current_user.email %></strong></p>

    <div class="row mb-12">
      <label>
        Delivery city<br>
        <input name="delivery_city" list="indian_cities" required placeholder="Start typing a city...">
        <datalist id="indian_cities">
          <% indian_cities.each do |c| %>
            <option value="<%= c %>"></option>
          <% end %>
        </datalist>
      </label>
    </div>

    <h3>Items</h3>
    <div class="table-scroll">
      <table id="lines">
        <colgroup>
          <col class="col-sku">
          <col class="col-qty">
          <col class="col-avail">
          <col class="col-unit">
          <col class="col-total">
          <col class="col-remove">
        </colgroup>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Qty</th>
            <th>Availability</th>
            <th class="right">Unit price</th>
            <th class="right">Line total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% lines = (@prefill && @prefill[:lines]).presence || [{ sku_code: (@skus.first&.code || ""), quantity: 1 }] %>
          <% lines.each do |line| %>
            <tr>
              <td>
                <select name="lines[][sku_code]" required>
                  <% @skus.each do |s| %>
                    <option value="<%= s.code %>" <%= "selected" if s.code == line[:sku_code].to_s %>><%= s.code %></option>
                  <% end %>
                </select>
                <div class="help wrap" data-sku-name></div>
              </td>
              <td>
                <input class="qty-input" type="number" name="lines[][quantity]" min="1" required value="<%= line[:quantity].to_i %>">
              </td>
              <td class="muted wrap" data-availability>—</td>
              <td class="muted right" data-unit-price>₹0.00</td>
              <td class="muted right" data-line-total>₹0.00</td>
              <td>
                <button type="button" class="secondary btn-sm" onclick="removeRow(this)" title="Remove item" aria-label="Remove item">Remove</button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="row">
      <button type="button" class="secondary" onclick="addRow()">Add item</button>
      <button type="submit">Create Order</button>
    </div>

    <p class="muted"><strong>Total (INR):</strong> <span id="order_total_inr">₹0.00</span></p>
  </form>
</div>

<script>
  // Price map (INR minor unit stored as integer) from server-rendered SKUs
  const SKU_PRICES = {
    <% @skus.each do |s| %>
      "<%= s.code %>": <%= s.respond_to?(:price_cents) ? s.price_cents.to_i : 0 %>,
    <% end %>
  };

  const SKU_NAMES = {
    <% @skus.each do |s| %>
      "<%= s.code %>": "<%= j s.name.to_s %>",
    <% end %>
  };

  // Availability map: SKU -> [{location, available}]
  const SKU_AVAILABILITY = {
    <% (@availability || {}).each do |sku_code, rows| %>
      "<%= sku_code %>": [
        <% (rows || []).each do |(_c,_n,_p,loc,avail)| %>
          { location: "<%= loc %>", available: <%= avail.to_i %> },
        <% end %>
      ],
    <% end %>
  };

  function formatINRFromMinor(minor) {
    const v = (minor || 0) / 100;
    return "₹" + v.toFixed(2);
  }

  function availabilityTextForSku(sku) {
    const rows = SKU_AVAILABILITY[sku] || [];
    if (!rows.length) return "—";
    return rows.map((r) => `${r.location}:${r.available}`).join(", ");
  }

  function recalcTotals() {
    const rows = document.querySelectorAll("#lines tbody tr");
    let totalMinor = 0;
    rows.forEach((tr) => {
      const skuSel = tr.querySelector('select[name="lines[][sku_code]"]');
      const qtyEl = tr.querySelector('input[name="lines[][quantity]"]');
      const nameEl = tr.querySelector("[data-sku-name]");
      const availEl = tr.querySelector("[data-availability]");
      const unitEl = tr.querySelector("[data-unit-price]");
      const lineEl = tr.querySelector("[data-line-total]");
      const sku = skuSel ? skuSel.value : "";
      const qty = qtyEl ? parseInt(qtyEl.value || "0", 10) : 0;
      const unitMinor = SKU_PRICES[sku] || 0;
      const lineMinor = unitMinor * qty;
      if (nameEl) nameEl.textContent = SKU_NAMES[sku] || "";
      if (availEl) availEl.textContent = availabilityTextForSku(sku);
      if (unitEl) unitEl.textContent = formatINRFromMinor(unitMinor);
      if (lineEl) lineEl.textContent = formatINRFromMinor(lineMinor);
      totalMinor += lineMinor;
    });
    const totalEl = document.getElementById("order_total_inr");
    if (totalEl) totalEl.textContent = formatINRFromMinor(totalMinor);
  }

  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (!tr) return;
    const tbody = document.querySelector("#lines tbody");
    if (tbody && tbody.querySelectorAll("tr").length <= 1) return;
    tr.remove();
    recalcTotals();
  }

  function addRow() {
    const tbody = document.querySelector("#lines tbody");
    if (!tbody) return;
    const first = tbody.querySelector("tr");
    if (!first) return;
    const clone = first.cloneNode(true);
    const qty = clone.querySelector('input[type="number"]');
    if (qty) qty.value = 1;
    tbody.appendChild(clone);
    attachRecalcHandlers(clone);
    recalcTotals();
  }

  function attachRecalcHandlers(root) {
    const row = root || document;
    row.querySelectorAll('#lines select[name="lines[][sku_code]"], #lines input[name="lines[][quantity]"]').forEach((el) => {
      el.addEventListener("change", recalcTotals);
      el.addEventListener("input", recalcTotals);
    });
  }

  attachRecalcHandlers(document);
  recalcTotals();
</script>


