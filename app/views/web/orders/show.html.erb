<div class="card">
  <div class="page-header">
    <div>
      <h2>Order <code>#<%= @order.id %></code></h2>
      <p class="muted">
        Customer: <%= @order.customer_email %>
        <% if @order.delivery_city.present? %> · Delivery city: <%= @order.delivery_city %><% end %>
      </p>
    </div>
    <div class="page-actions">
      <% if @order.payment_pending? && !@order.cancelled? && !@order.fulfilled? %>
        <a class="btn" href="<%= new_payment_path(order_id: @order.id) %>">Pay now</a>
      <% end %>
      <a class="btn secondary" href="<%= orders_path %>">Back</a>
    </div>
  </div>

  <div class="row muted">
    <span>Status: <span class="<%= badge_class_for_order_status(@order.status) %>"><%= @order.status.humanize %></span></span>
    <span>Payment: <span class="<%= badge_class_for_payment_status(@order.payment_status) %>"><%= @order.payment_status.humanize %></span></span>
    <span>Created: <strong><%= @order.created_at&.strftime("%Y-%m-%d %H:%M IST") %></strong></span>
    <% if (t = @order.last_fulfilled_at).present? %>
      <span>Last fulfilled: <strong><%= t.strftime("%Y-%m-%d %H:%M IST") %></strong></span>
    <% end %>
  </div>

  <p class="muted mt-10">
    Idempotency key: <code><%= @order.idempotency_key %></code>
  </p>

  <% total_qty = @order.order_lines.sum(&:quantity) %>
  <% total_fulfilled = @order.order_lines.sum(&:fulfilled_quantity) %>
  <% total_reserved = @order.inventory_reservations.sum(&:quantity) %>
  <% total_reserved_fulfilled = @order.inventory_reservations.sum(&:fulfilled_quantity) %>

  <div class="row muted">
    <span><strong>Ordered</strong>: <%= total_qty %></span>
    <span><strong>Fulfilled</strong>: <%= total_fulfilled %></span>
    <span><strong>Reserved</strong>: <%= total_reserved %></span>
    <span><strong>Reserved fulfilled</strong>: <%= total_reserved_fulfilled %></span>
  </div>

  <div class="row mt-10">
    <% if @order.cancelled? %>
      <span class="muted">This order is cancelled.</span>
    <% elsif @order.fulfilled? %>
      <span class="muted">This order is fulfilled.</span>
    <% else %>
      <form method="post" action="<%= cancel_order_path(@order) %>" class="inline">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button class="secondary" type="submit" onclick="return confirm('Cancel this order?');">Cancel order</button>
      </form>
    <% end %>
  </div>

  <h3>Lines</h3>
  <table>
    <thead>
      <tr>
        <th>SKU</th>
        <th>Qty</th>
        <th>Fulfilled</th>
        <th>Remaining</th>
      </tr>
    </thead>
    <tbody>
      <% @order.order_lines.each do |l| %>
        <tr>
          <td><%= l.sku.code %></td>
          <td><%= l.quantity %></td>
          <td><%= l.fulfilled_quantity %></td>
          <td><%= l.quantity - l.fulfilled_quantity %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h3>Reservations</h3>
  <table>
    <thead>
      <tr>
        <th>Reservation</th>
        <th>SKU</th>
        <th>Warehouse</th>
        <th>Location</th>
        <th>Qty</th>
        <th>Fulfilled</th>
        <th>Remaining</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <% @order.inventory_reservations.each do |r| %>
        <tr>
          <td><code><%= r.id %></code></td>
          <td><%= r.sku.code %></td>
          <td><%= r.warehouse.code %></td>
          <td><%= r.warehouse.location %></td>
          <td><%= r.quantity %></td>
          <td><%= r.fulfilled_quantity %></td>
          <td><%= r.remaining_quantity %></td>
          <td><span class="<%= badge_class_for_reservation_status(r.status) %>"><%= r.status.humanize %></span></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h3>Fulfillments</h3>
  <% if @order.fulfillments.empty? %>
    <p class="muted">No fulfillments created yet.</p>
  <% else %>
    <% @order.fulfillments.order(:id).each do |f| %>
      <div class="card mt-12">
        <p class="muted">
          Fulfillment <code>#<%= f.id %></code>
          — Warehouse: <%= f.warehouse.code %> (<%= f.warehouse.location %>)
          — Status: <span class="<%= badge_class_for_fulfillment_status(f.status) %>"><%= f.status.humanize %></span>
        </p>

        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Qty</th>
              <th>Reservation</th>
            </tr>
          </thead>
          <tbody>
            <% f.fulfillment_items.order(:id).each do |fi| %>
              <tr>
                <td><%= fi.sku.code %></td>
                <td><%= fi.quantity %></td>
                <td><code><%= fi.inventory_reservation_id %></code></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% end %>

  <div class="row">
    <a href="<%= root_path %>">Place another order</a>
  </div>
</div>


